<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏ï‡∏±‡∏ß‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì: ‡πÅ‡∏ú‡∏ô 3 ‡∏Å‡πâ‡∏≠‡∏ô (‡∏Ñ‡∏≠‡∏°‡∏°‡∏≤ + ‡∏Å‡∏£‡∏≤‡∏ü)</title>
  <style>
    :root{
      --bg:#0b1020;--panel:#131a33;--muted:#aab3d2;--prim:#5ad7ff;--ok:#32d27a;--warn:#ffcc66;--bad:#ff6b6b;--total:#d6b3ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0b1225);color:#e8edff;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans Thai",sans-serif;}
    .page{max-width:1100px;margin:24px auto;padding:16px}
    h1{font-size:clamp(20px,2.6vw,32px);margin:0 0 12px;color:#fff}
    p.sub{color:var(--muted);margin:.25rem 0 1rem}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px 16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;background:#0f1530;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 12px;color:#e8edff;font-size:15px;outline:none}
    input:focus,select:focus{border-color:var(--prim);box-shadow:0 0 0 3px rgba(90,215,255,.15)}
    .row{display:grid;grid-template-columns:1fr 140px 120px;gap:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg,#1a86ff,#1755ff);border:none;padding:10px 14px;border-radius:12px;color:#fff;font-weight:600;cursor:pointer}
    .btn.secondary{background:#223169}
    .btn:active{transform:translateY(1px)}
    .stat{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;background:#0f1736;border:1px solid rgba(255,255,255,.08)}
    .stat b{font-size:20px;color:#fff}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.12);color:#d6ddff}
    .warn{color:var(--warn)}
    .muted{color:var(--muted)}

    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px 10px;border-bottom:1px dashed rgba(255,255,255,.12);text-align:right}
    th{position:sticky;top:0;background:#10183a;text-align:right;z-index:1}
    th:first-child, td:first-child{text-align:left}
    .right{justify-self:end}
    details{background:#0e1531;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px}

    .two-col{grid-column:span 12}
    @media(min-width:860px){
      .two-col{grid-column:span 8}
      .side{grid-column:span 4}
    }
    .stack{display:flex;gap:10px;flex-wrap:wrap}
    .tag{font-size:12px;padding:3px 8px;border-radius:999px;background:#0b1333;color:#d0d7ff;border:1px solid rgba(255,255,255,.1)}
    .footer{margin:18px 0 8px;color:#7f8bb3;font-size:12px}
    .num-warn{color:var(--bad);font-weight:700}
    .good{color:var(--ok)}

    /* Chart */
    #chart{width:100%;height:260px;display:block;border-radius:12px;background:#0c1538;border:1px solid rgba(255,255,255,.08)}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .legend .item{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#cdd6ff;background:#0b1333;border:1px solid rgba(255,255,255,.08);padding:4px 8px;border-radius:999px}
    .sw{width:10px;height:10px;border-radius:2px;display:inline-block}
    .sw.b1{background:var(--prim)}
    .sw.b2{background:var(--ok)}
    .sw.b3{background:var(--warn)}
    .sw.total{background:var(--total)}
  </style>
</head>
<body>
  <div class="page">
    <h1>‡∏ï‡∏±‡∏ß‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì ‚Äì ‡πÅ‡∏ú‡∏ô 3 ‡∏Å‡πâ‡∏≠‡∏ô</h1>
    <p class="sub">‡∏ï‡∏£‡∏£‡∏Å‡∏∞: <span class="pill">‡∏Å‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1 (‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å) = 2√ó‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</span> ¬∑ <span class="pill">‡∏Å‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2 (‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥‚Äì‡∏Å‡∏•‡∏≤‡∏á) = 5√ó‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏õ‡∏µ @4%</span> ¬∑ <span class="pill">‡∏Å‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3 (‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á) = ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ @7%</span> ¬∑ ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ü‡πâ‡∏≠‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</p>

    <div class="grid">
      <div class="card two-col">
        <div class="grid" style="grid-template-columns:repeat(12,1fr);gap:14px">
          <div style="grid-column:span 6">
            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì (‡∏ö‡∏≤‡∏ó)</label>
            <input type="text" inputmode="numeric" id="startAmount" value="10,000,000" data-format="comma" />
          </div>
          <div style="grid-column:span 4">
            <label>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì</label>
            <input type="text" inputmode="numeric" id="expenseAmount" value="40,000" data-format="comma" />
          </div>
          <div style="grid-column:span 2">
            <label>&nbsp;</label>
            <select id="expensePeriod">
              <option value="monthly" selected>‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
              <option value="yearly">‡∏ö‡∏≤‡∏ó/‡∏õ‡∏µ</option>
            </select>
          </div>
          <div style="grid-column:span 4">
            <label>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ü‡πâ‡∏≠ (%) ‡∏ï‡πà‡∏≠‡∏õ‡∏µ</label>
            <input type="number" id="inflation" value="3" min="0" max="20" step="0.1" />
          </div>
          <div style="grid-column:span 4">
            <label>‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Å‡∏µ‡πà‡∏õ‡∏µ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß)</label>
            <input type="number" id="maxYears" value="120" min="1" max="200" />
          </div>
          <div style="grid-column:span 4;align-self:end">
            <button class="btn" id="calcBtn">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
            <button class="btn secondary" id="exportBtn" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô CSV" style="margin-left:8px">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
          </div>
        </div>

        <details style="margin-top:12px">
          <summary>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á (‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô)</summary>
          <div class="grid" style="grid-template-columns:repeat(12,1fr);gap:14px;margin-top:10px">

            <div style="grid-column:span 4">
      <label>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1 (‡πÄ‡∏ó‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏õ‡∏µ)</label>
      <input type="number" id="m1" value="2" step="0.1" />
    </div>
    <div style="grid-column:span 4">
      <label>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2 (‡πÄ‡∏ó‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏õ‡∏µ)</label>
      <input type="number" id="m2" value="5" step="0.1" />
    </div>
            
            <div style="grid-column:span 4">
              <label>‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1 (‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å) %/‡∏õ‡∏µ</label>
              <input type="number" id="r1" value="0" step="0.1" />
            </div>
            <div style="grid-column:span 4">
              <label>‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2 (‡∏ï‡∏£‡∏≤‡∏™‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ) %/‡∏õ‡∏µ</label>
              <input type="number" id="r2" value="4" step="0.1" />
            </div>
            <div style="grid-column:span 4">
              <label>‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3 (‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á) %/‡∏õ‡∏µ</label>
              <input type="number" id="r3" value="7" step="0.1" />
            </div>
          </div>
        </details>
      </div>

      <div class="card side">
        <div id="warnings" class="muted" style="min-height:22px"></div>
        <div class="stat" style="margin-top:10px">
          <div style="font-size:28px">‚è≥</div>
          <div>
            <div class="muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏î‡πâ</div>
            <b id="yearsResult">‚Äî</b>
          </div>
        </div>
        <div class="stat" style="margin-top:10px">
          <div style="font-size:28px">üí∞</div>
          <div>
            <div class="muted">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°‡∏õ‡∏•‡∏≤‡∏¢‡∏õ‡∏µ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î)</div>
            <b id="endingWealth">‚Äî</b>
          </div>
        </div>
        <div class="stack" style="margin-top:10px">
          <span class="tag">‡∏™‡∏≥‡∏£‡∏≠‡∏á 2 ‡∏õ‡∏µ</span>
          <span class="tag">‡∏ï‡∏£‡∏≤‡∏™‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ 5 ‡∏õ‡∏µ</span>
          <span class="tag">‡∏£‡∏µ‡∏ö‡∏≤‡∏•‡∏≤‡∏ô‡∏ã‡πå‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</span>
          <span class="tag">‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ü‡πâ‡∏≠</span>
        </div>
      </div>

      <!-- Chart Card -->
      <div class="card two-col">
        <h3 style="margin:2px 0 10px">‡∏Å‡∏£‡∏≤‡∏ü‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡πâ‡∏≠‡∏ô (‡∏õ‡∏•‡∏≤‡∏¢‡∏õ‡∏µ)</h3>
        <canvas id="chart"></canvas>
        <div class="legend" id="legend">
          <span class="item"><span class="sw b1"></span> ‡∏Å‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1</span>
          <span class="item"><span class="sw b2"></span> ‡∏Å‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2</span>
          <span class="item"><span class="sw b3"></span> ‡∏Å‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3</span>
          <span class="item"><span class="sw total"></span> ‡∏£‡∏ß‡∏°</span>
        </div>
      </div>

      <div class="card two-col" style="overflow:auto">
        <div class="row" style="grid-template-columns:1fr auto auto">
          <h3 style="margin:2px 0">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡πâ‡∏≠‡∏ô‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏µ</h3>
          <div class="right muted" id="tableNote"></div>
        </div>
        <table id="resultTable">
          <thead>
            <tr>
              <th>‡∏õ‡∏µ</th>
              <th>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢/‡∏õ‡∏µ</th>
              <th>‡∏Å‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1 (‡∏õ‡∏•‡∏≤‡∏¢‡∏õ‡∏µ)</th>
              <th>‡∏Å‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2 (‡∏õ‡∏•‡∏≤‡∏¢‡∏õ‡∏µ)</th>
              <th>‡∏Å‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3 (‡∏õ‡∏•‡∏≤‡∏¢‡∏õ‡∏µ)</th>
              <th>‡∏£‡∏ß‡∏°‡∏õ‡∏•‡∏≤‡∏¢‡∏õ‡∏µ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <details style="margin-top:12px">
          <summary>‡∏î‡∏π‡∏™‡∏°‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô: ‡∏ñ‡∏≠‡∏ô‚Äì‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‚Äì‡∏£‡∏µ‡∏ö‡∏≤‡∏•‡∏≤‡∏ô‡∏ã‡πå)</summary>
          <div id="auditLog" style="white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace;font-size:12.5px;color:#d9e1ff"></div>
        </details>
        <div class="footer">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÅ‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡∏¥‡∏á‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏≤‡∏à‡∏ï‡πà‡∏≤‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ</div>
      </div>
    </div>
  </div>

<script>
const fmtTHB = v => new Intl.NumberFormat('th-TH', {style:'currency', currency:'THB', maximumFractionDigits:0}).format(Math.max(0, v||0));
const fmtNum = v => new Intl.NumberFormat('th-TH', {maximumFractionDigits:2}).format(v);

// ===== Input comma formatting =====
function formatWithCommas(nStr){
  const parts = (nStr || '').replace(/[^\d.]/g,'').split('.')
  parts[0] = parts[0].replace(/^0+(\d)/,'$1')
  parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  return parts.join('.')
}
function attachCommaFormatting(input){
  const onInput = () => {
    const selStart = input.selectionStart;
    const raw = input.value.replace(/,/g,'').replace(/[^\d.]/g,'');
    const before = input.value;
    const formatted = formatWithCommas(raw);
    input.value = formatted;
    const diff = formatted.length - before.length;
    const newPos = Math.max(0, (selStart||0) + diff);
    input.setSelectionRange(newPos,newPos);
  };
  input.addEventListener('input', onInput);
  input.addEventListener('blur', onInput);
  input.value = formatWithCommas(input.value);
}
function getNum(id){
  const el = document.getElementById(id);
  const val = (el.value||'').toString().replace(/,/g,'').replace(/[^\d.]/g,'');
  return parseFloat(val||'0') || 0;
}

// ===== Simulation core =====
function simulate(opts){
  let {startAmount, expenseAnnual0, inflation, r1, r2, r3, m1, m2, maxYears} = opts;
  inflation = inflation/100; r1=r1/100; r2=r2/100; r3=r3/100;

  let b1 = 0, b2 = 0, b3 = 0;
  let year = 0; let expense = expenseAnnual0;
  const rows = []; const audit = [];

  const t1 = m1 * expense;
  const t2 = m2 * expense;
  b1 = Math.min(startAmount, t1);
  let rem = startAmount - b1;
  b2 = Math.min(rem, t2); rem -= b2;
  b3 = Math.max(0, rem);
  if (startAmount < t1 + t2) {
    audit.push(`‚ö†Ô∏è ‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1 ‡πÅ‡∏•‡∏∞ 2 ‡πÉ‡∏ô‡∏õ‡∏µ‡πÅ‡∏£‡∏Å (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ${fmtTHB(t1+t2)} ‡πÅ‡∏ï‡πà‡∏°‡∏µ ${fmtTHB(startAmount)})`);
  }

  let yearsAlive = 0;
  let endedWithWealth = 0;

  while (year < maxYears){
    year++;
    const totalBefore = b1+b2+b3;
    audit.push(`\n‚ñ∂Ô∏è ‡∏õ‡∏µ‡∏ó‡∏µ‡πà ${year}: ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ = ${fmtTHB(expense)} | ‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤ = ${fmtTHB(totalBefore)}`);

    if (totalBefore <= 0){
      audit.push(`‚ùå ‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏µ‡∏ó‡∏µ‡πà ${year}`);
      break;
    }
    if (totalBefore < expense){
      const frac = totalBefore/expense;
      yearsAlive += frac;
      audit.push(`‚è≥ ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${fmtNum(frac*12)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÉ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà ${year} ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏°‡∏î`);
      b1 = b2 = b3 = 0;
      rows.push({year:`${year} (‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô)`, expense, b1, b2, b3});
      endedWithWealth = 0;
      break;
    }

    // Withdraw order
    let need = expense;
    let w1 = Math.min(b1, need); b1 -= w1; need -= w1;
    let w2 = 0, w3 = 0;
    if (need>0){ w2 = Math.min(b2, need); b2 -= w2; need -= w2; }
    if (need>0){ w3 = Math.min(b3, need); b3 -= w3; need -= w3; }
    audit.push(`‡∏ñ‡∏≠‡∏ô: ‡∏à‡∏≤‡∏Å‡∏Å‡πâ‡∏≠‡∏ô1 ${fmtTHB(w1)} | ‡∏Å‡πâ‡∏≠‡∏ô2 ${fmtTHB(w2)} | ‡∏Å‡πâ‡∏≠‡∏ô3 ${fmtTHB(w3)}`);

    // Growth
    const g1 = b1*r1; b1 += g1;
    const g2 = b2*r2; b2 += g2;
    const g3 = b3*r3; b3 += g3;
    audit.push(`‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏õ‡∏•‡∏≤‡∏¢‡∏õ‡∏µ: ‡∏Å1 ${fmtTHB(g1)} | ‡∏Å2 ${fmtTHB(g2)} | ‡∏Å3 ${fmtTHB(g3)}`);

    // Next year targets (inflation)
    const nextExpense = expense*(1+inflation);
    const t1n = m1 * nextExpense;
    const t2n = m2 * nextExpense;

    // Rebalance
    let top12 = 0, top13 = 0, top23 = 0;
    let need1 = Math.max(0, t1n - b1);
    if (need1>0){ const x = Math.min(b2, need1); b2 -= x; b1 += x; need1 -= x; top12 = x; }
    if (need1>0){ const y = Math.min(b3, need1); b3 -= y; b1 += y; need1 -= y; top13 = y; }
    let need2 = Math.max(0, t2n - b2);
    if (need2>0){ const z = Math.min(b3, need2); b3 -= z; b2 += z; need2 -= z; top23 = z; }

    audit.push(`‡∏£‡∏µ‡∏ö‡∏≤‡∏•‡∏≤‡∏ô‡∏ã‡πå: ‡πÄ‡∏ï‡∏¥‡∏°‡∏Å1‡∏à‡∏≤‡∏Å‡∏Å2 ${fmtTHB(top12)} | ‡πÄ‡∏ï‡∏¥‡∏°‡∏Å1‡∏à‡∏≤‡∏Å‡∏Å3 ${fmtTHB(top13)} | ‡πÄ‡∏ï‡∏¥‡∏°‡∏Å2‡∏à‡∏≤‡∏Å‡∏Å3 ${fmtTHB(top23)}`);

    rows.push({year, expense, b1, b2, b3});
    endedWithWealth = b1+b2+b3;

    expense = nextExpense;
  }

  const endedByMaxYears = (yearsAlive === 0 && rows.length === (opts.maxYears) && (b1+b2+b3) > 0);
  let fullYears = rows.filter(r=>Number.isFinite(r.year)).length;
  yearsAlive += fullYears;

  return {rows, audit: audit.join('\n'), yearsAlive, endedWithWealth, endedByMaxYears};
}

function toCSV(rows){
  const header = ["‡∏õ‡∏µ","‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢/‡∏õ‡∏µ","‡∏Å‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà1‡∏õ‡∏•‡∏≤‡∏¢‡∏õ‡∏µ","‡∏Å‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà2‡∏õ‡∏•‡∏≤‡∏¢‡∏õ‡∏µ","‡∏Å‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà3‡∏õ‡∏•‡∏≤‡∏¢‡∏õ‡∏µ","‡∏£‡∏ß‡∏°‡∏õ‡∏•‡∏≤‡∏¢‡∏õ‡∏µ"];
  const body = rows.map(r=>[
    r.year,
    Math.round(r.expense),
    Math.round(r.b1),
    Math.round(r.b2),
    Math.round(r.b3),
    Math.round(r.b1+r.b2+r.b3)
  ]);
  const csv = [header.join(","), ...body.map(r=>r.join(","))].join("\n");
  return csv;
}

// ===== Simple Canvas Line Chart =====
let lastRows = [];
function shortTHB(n){
  if (n>=1e12) return (n/1e12).toFixed(1).replace(/\.0$/,'')+"‡∏•.";
  if (n>=1e9)  return (n/1e9).toFixed(1).replace(/\.0$/,'')+"‡∏û‡∏±‡∏ô‡∏•.";
  if (n>=1e6)  return (n/1e6).toFixed(1).replace(/\.0$/,'')+"‡∏•.";
  if (n>=1e3)  return (n/1e3).toFixed(1).replace(/\.0$/,'')+"‡∏û.";
  return Math.round(n).toString();
}
function drawChart(rows){
  const canvas = document.getElementById('chart');
  if (!canvas) return;
  const ratio = window.devicePixelRatio || 1;
  const cssW = canvas.clientWidth || 800;
  const cssH = canvas.clientHeight || 260;
  canvas.width = Math.floor(cssW * ratio);
  canvas.height = Math.floor(cssH * ratio);
  const ctx = canvas.getContext('2d');
  ctx.scale(ratio, ratio);
  ctx.clearRect(0,0,cssW,cssH);

  const pad = {left:70, right:16, top:12, bottom:28};
  const plotW = cssW - pad.left - pad.right;
  const plotH = cssH - pad.top - pad.bottom;

  const x = i => pad.left + (rows.length<=1?0:(i*(plotW/(rows.length-1))));
  const totals = rows.map(r=>r.b1+r.b2+r.b3);
  const maxY = Math.max(1, ...totals, ...rows.map(r=>r.b1), ...rows.map(r=>r.b2), ...rows.map(r=>r.b3));
  const yMax = maxY*1.08;
  const y = v => pad.top + plotH - (v/yMax)*plotH;

  // gridlines
  ctx.strokeStyle = 'rgba(255,255,255,0.12)';
  ctx.lineWidth = 1;
  const gridN = 5;
  ctx.beginPath();
  for (let g=0; g<=gridN; g++){
    const gy = pad.top + (plotH*g/gridN);
    ctx.moveTo(pad.left, gy); ctx.lineTo(pad.left+plotW, gy);
  }
  ctx.stroke();

  // y labels
  ctx.fillStyle = '#aab3d2';
  ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto';
  for (let g=0; g<=gridN; g++){
    const val = yMax*(1 - g/gridN);
    const gy = pad.top + (plotH*g/gridN) - 2;
    ctx.fillText(shortTHB(val), 8, gy);
  }

  // x labels (years)
  ctx.textAlign = 'center';
  for (let i=0;i<rows.length;i++){
    const xi = x(i);
    const label = String(rows[i].year).replace(/ \(.*\)/,'');
    if (i===0 || i===rows.length-1 || (rows.length>12 && i%Math.ceil(rows.length/12)===0)){
      ctx.fillText(label, xi, cssH-8);
    }
  }
  ctx.textAlign = 'left';

  function drawSeries(values, color){
    if (!values.length) return;
    ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.beginPath();
    values.forEach((v,i)=>{ const xi=x(i), yi=y(v); if(i===0) ctx.moveTo(xi,yi); else ctx.lineTo(xi,yi); });
    ctx.stroke();
  }
  drawSeries(rows.map(r=>r.b1), getComputedStyle(document.documentElement).getPropertyValue('--prim').trim()||'#5ad7ff');
  drawSeries(rows.map(r=>r.b2), getComputedStyle(document.documentElement).getPropertyValue('--ok').trim()||'#32d27a');
  drawSeries(rows.map(r=>r.b3), getComputedStyle(document.documentElement).getPropertyValue('--warn').trim()||'#ffcc66');
  drawSeries(rows.map(r=>r.b1+r.b2+r.b3), getComputedStyle(document.documentElement).getPropertyValue('--total').trim()||'#d6b3ff');
}
window.addEventListener('resize', ()=>drawChart(lastRows));

function run(){
  const startAmount = getNum('startAmount');
  let expense = getNum('expenseAmount');
  const period = document.getElementById('expensePeriod').value;
  const inflation = +document.getElementById('inflation').value || 0;
  const r1 = +document.getElementById('r1').value || 0;
  const r2 = +document.getElementById('r2').value || 0;
  const r3 = +document.getElementById('r3').value || 0;
  const m1 = +document.getElementById('m1').value || 2;
  const m2 = +document.getElementById('m2').value || 5;
  const maxYears = +document.getElementById('maxYears').value || 120;

  const warnings = [];
  if (expense<=0) warnings.push('‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (> 0)');
  if (startAmount<=0) warnings.push('‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô (> 0)');
  if (r1<0||r2<0||r3<0) warnings.push('‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö');
  document.getElementById('warnings').innerHTML = warnings.length? ('‚ö†Ô∏è '+warnings.join(' ¬∑ ')) : '';
  if (warnings.length) return;

  const expenseAnnual0 = period==='monthly' ? expense*12 : expense;

  const {rows, audit, yearsAlive, endedWithWealth, endedByMaxYears} = simulate({startAmount, expenseAnnual0, inflation, r1, r2, r3, m1, m2, maxYears});

  // Fill table
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    const total = r.b1+r.b2+r.b3;
    tr.innerHTML = `
      <td>${r.year}</td>
      <td>${fmtTHB(r.expense)}</td>
      <td>${fmtTHB(r.b1)}</td>
      <td>${fmtTHB(r.b2)}</td>
      <td>${fmtTHB(r.b3)}</td>
      <td>${fmtTHB(total)}</td>`;
    tbody.appendChild(tr);
  });

  document.getElementById('yearsResult').textContent = endedByMaxYears ? `‚â• ${maxYears} ‡∏õ‡∏µ (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î)` : `${fmtNum(yearsAlive)} ‡∏õ‡∏µ`;
  document.getElementById('endingWealth').textContent = fmtTHB(endedWithWealth);
  document.getElementById('auditLog').textContent = audit;
  document.getElementById('tableNote').textContent = rows.length ? `${rows.length} ‡πÅ‡∏ñ‡∏ß` : '';

  // Draw chart
  lastRows = rows;
  drawChart(rows);
}

function exportCSV(){
  const tbody = document.getElementById('tbody');
  if (!tbody.children.length){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å'); return; }
  const period = document.getElementById('expensePeriod').value;
  const expenseAnnual0 = period==='monthly' ? getNum('expenseAmount')*12 : getNum('expenseAmount');
  const payload = simulate({
    startAmount:getNum('startAmount'),
    expenseAnnual0,
    inflation:+document.getElementById('inflation').value||0,
    r1:+document.getElementById('r1').value||0,
    r2:+document.getElementById('r2').value||0,
    r3:+document.getElementById('r3').value||0,
    maxYears:+document.getElementById('maxYears').value||120,
  });
  const csv = toCSV(payload.rows);
  const blob = new Blob(["\uFEFF"+csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'retirement_bucket_simulator.csv'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

// Events
 document.getElementById('calcBtn').addEventListener('click', run);
 document.getElementById('exportBtn').addEventListener('click', exportCSV);
 // Attach comma formatting to money inputs
 Array.from(document.querySelectorAll('input[data-format="comma"]')).forEach(attachCommaFormatting);
 // Auto-run once with defaults
 run();
</script>
</body>
</html>
