<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เครื่องคำนวณ TVM รายเดือน</title>
    <style>
        /* CSS Styles */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f4f4f4;
            margin: 0;
        }

        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 25px;
        }

        .input-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            text-align: left;
        }

        .input-group label {
            width: 150px;
            margin-right: 15px;
            font-weight: bold;
            color: #555;
        }

        .input-group input[type="number"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            width: 150px; /* Adjusted width as result is now in input */
            text-align: right; /* Align text to right for numbers */
        }
        
        /* Style for calculated fields */
        .input-group input[data-calculated="true"] {
            color: #28a745; /* Green color for calculated results */
            font-weight: bold;
        }

        /* Style for manual input fields (default) */
        .input-group input:not([data-calculated="true"]) {
            color: #333; /* Default text color for manual input */
            font-weight: normal;
        }

        .input-group button {
            padding: 10px 15px;
            margin-left: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }

        .input-group button:hover {
            background-color: #0056b3;
        }
        
        .clear-button {
            margin-top: 20px;
            padding: 12px 25px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .clear-button:hover {
            background-color: #c82333;
        }

        .note {
            margin-top: 20px;
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>เครื่องคำนวณ Time Value of Money (TVM) รายเดือน</h1>

        <div class="input-group">
            <label for="pv">Present Value (PV):</label>
            <input type="number" id="pv" step="any" placeholder="ป้อนค่า PV" oninput="clearCalculatedState('pv')">
            <button onclick="calculate('pv')">คำนวณ PV</button>
        </div>

        <div class="input-group">
            <label for="payment">Monthly Payment (PMT):</label>
            <input type="number" id="payment" step="any" placeholder="ป้อนค่า PMT ต่อเดือน" oninput="clearCalculatedState('payment')">
            <button onclick="calculate('payment')">คำนวณ PMT</button>
        </div>

        <div class="input-group">
            <label for="fv">Future Value (FV):</label>
            <input type="number" id="fv" step="any" placeholder="ป้อนค่า FV" oninput="clearCalculatedState('fv')">
            <button onclick="calculate('fv')">คำนวณ FV</button>
        </div>

        <div class="input-group">
            <label for="interest">Annual Interest (%):</label>
            <input type="number" id="interest" step="any" placeholder="ป้อนค่าดอกเบี้ยต่อปี (%)" oninput="clearCalculatedState('interest')">
            <button onclick="calculate('interest')">คำนวณ % ดอกเบี้ย</button>
        </div>

        <div class="input-group">
            <label for="period">Number of Months (N):</label>
            <input type="number" id="period" step="any" placeholder="ป้อนจำนวนเดือน" oninput="clearCalculatedState('period')">
            <button onclick="calculate('period')">คำนวณ N</button>
        </div>

        <button class="clear-button" onclick="clearAll()">ล้างข้อมูลทั้งหมด</button>
        <p class="note">**ข้อควรระวัง: ต้องป้อนค่าที่ต้องการคำนวณเป็น 0 หรือเว้นว่างไว้ และป้อนค่าอื่นๆ ให้ครบถ้วน**</p>
    </div>

    <script>
        // Store raw numeric values in an object to avoid parsing formatted strings
        const tvmValues = {
            pv: 0,
            payment: 0,
            fv: 0,
            interest: 0, // This will be annual percentage
            period: 0
        };

        // Function to update the raw value and also the displayed input field
        function updateValueAndDisplay(id, rawValue) {
            tvmValues[id] = rawValue; // Store raw value
            const inputElement = document.getElementById(id);
            if (rawValue !== null && !isNaN(rawValue)) {
                // Format for display
                inputElement.value = rawValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else {
                inputElement.value = '';
            }
        }

        // Function to set the calculated result in the input field
        function setResult(id, value) {
            const inputElement = document.getElementById(id);
            if (value !== null && !isNaN(value)) {
                tvmValues[id] = value; // Store the raw calculated value
                inputElement.value = value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                inputElement.setAttribute('data-calculated', 'true'); // Mark as calculated
            } else {
                tvmValues[id] = 0; // Set raw value to 0 if not a number
                inputElement.value = '';
                inputElement.removeAttribute('data-calculated');
            }
        }

        // Clears the 'data-calculated' attribute when user types in the input
        function clearCalculatedState(id) {
            const inputElement = document.getElementById(id);
            inputElement.removeAttribute('data-calculated');
            // Also, update the raw value storage immediately when user types
            // This is crucial for correct subsequent calculations.
            tvmValues[id] = parseFloat(inputElement.value) || 0;
        }

        // Main calculate function
        function calculate(target) {
            // Get current values from the stored tvmValues object
            // These are always raw numbers, regardless of display formatting
            let pv = tvmValues.pv;
            let pmt = tvmValues.payment;
            let fv = tvmValues.fv;
            let i_annual = tvmValues.interest;
            let n = tvmValues.period;

            // Convert annual interest to monthly interest
            let i_monthly = (i_annual / 100) / 12;

            let calculatedValue = null;

            // --- Logic for counting known variables ---
            // A field is "known" if its value is not empty.
            // We use document.getElementById(id).value !== '' to check if the input is filled by user or previous calculation.
            let filledOtherFields = 0;
            if (target !== 'pv' && document.getElementById('pv').value !== '') filledOtherFields++;
            if (target !== 'payment' && document.getElementById('payment').value !== '') filledOtherFields++;
            if (target !== 'fv' && document.getElementById('fv').value !== '') filledOtherFields++;
            if (target !== 'interest' && document.getElementById('interest').value !== '') filledOtherFields++;
            if (target !== 'period' && document.getElementById('period').value !== '') filledOtherFields++;
            
            // Allow 0 as a valid known input. The check `document.getElementById('id').value !== ''` handles this.
            // If user enters 0, it's not empty, so it's a known field.
            // If user leaves blank, it's empty, and not counted.

            if (filledOtherFields < 4) {
                alert("กรุณาป้อนค่าในช่องที่ไม่ใช่เป้าหมายที่จะคำนวณให้ครบ 4 ช่อง (ไม่เว้นว่าง)");
                return;
            }
            // --- END of Logic for counting known variables ---

            try {
                switch (target) {
                    case 'pv':
                        if (n === 0) {
                            calculatedValue = -fv;
                        } else if (i_monthly === 0) {
                            calculatedValue = fv - (pmt * n);
                        } else {
                            const pv_fv = fv / Math.pow(1 + i_monthly, n);
                            const pv_annuity = pmt * (1 - Math.pow(1 + i_monthly, -n)) / i_monthly;
                            calculatedValue = -(pv_fv + pv_annuity);
                        }
                        setResult('pv', calculatedValue);
                        break;

                    case 'payment':
                        if (n === 0) {
                            calculatedValue = 0;
                        } else if (i_monthly === 0) {
                            calculatedValue = (fv - pv) / n;
                        } else {
                            if (Math.abs(Math.pow(1 + i_monthly, n) - 1) < 1e-9) { 
                                calculatedValue = 0; 
                            } else {
                                calculatedValue = (fv - (pv * Math.pow(1 + i_monthly, n))) * i_monthly / (Math.pow(1 + i_monthly, n) - 1);
                                calculatedValue = -calculatedValue; // Standard convention: PMT is an outflow
                            }
                        }
                        setResult('payment', calculatedValue);
                        break;

                    case 'fv':
                        if (n === 0) {
                            calculatedValue = -pv;
                        } else if (i_monthly === 0) {
                            calculatedValue = pv + (pmt * n);
                        } else {
                            const fv_pv = pv * Math.pow(1 + i_monthly, n);
                            const fv_annuity = pmt * (Math.pow(1 + i_monthly, n) - 1) / i_monthly;
                            calculatedValue = -(fv_pv + fv_annuity);
                        }
                        setResult('fv', calculatedValue);
                        break;

                    case 'interest':
                        let low = 0.00001;
                        let high = 0.5;
                        let iterations = 1000;
                        let guess_monthly = 0;
                        let found = false;

                        for (let k = 0; k < iterations; k++) {
                            guess_monthly = (low + high) / 2;
                            if (guess_monthly === 0) {
                                low = 0.00001;
                                continue;
                            }
                            
                            const test_fv_pv = pv * Math.pow(1 + guess_monthly, n);
                            const test_fv_annuity = pmt * (Math.pow(1 + guess_monthly, n) - 1) / guess_monthly;
                            const current_fv = -(test_fv_pv + test_fv_annuity);

                            if (Math.abs(current_fv - fv) < 0.01) { 
                                calculatedValue = guess_monthly * 12 * 100;
                                found = true;
                                break;
                            }
                            if (current_fv < fv) { 
                                high = guess_monthly;
                            } else { 
                                low = guess_monthly;
                            }
                        }

                        if (found) {
                            setResult('interest', calculatedValue);
                        } else {
                            alert("ไม่สามารถคำนวณอัตราดอกเบี้ยได้ด้วยข้อมูลที่มี หรือต้องใช้วิธีการคำนวณที่ซับซ้อนกว่านี้");
                            setResult('interest', NaN); // Use NaN to signify "not a number" for input field
                        }
                        break;

                    case 'period':
                        if (i_monthly === 0) {
                            if (pmt !== 0) {
                                calculatedValue = (fv - pv) / pmt;
                            } else {
                                calculatedValue = 0;
                            }
                        } else {
                            const term1 = (fv * i_monthly) + pmt;
                            const term2 = (pv * i_monthly) + pmt;
                            if (term1 <= 0 || term2 <= 0 || (1 + i_monthly) <= 0) {
                                 alert("เกิดข้อผิดพลาดในการคำนวณจำนวนงวด: ค่าภายใน Logarithm ไม่ถูกต้อง (อาจเกิดจากค่า PV, FV, PMT, i_monthly ที่ไม่สอดคล้องกัน)");
                                 calculatedValue = NaN; // Use NaN
                            } else {
                                 calculatedValue = Math.log(term1 / term2) / Math.log(1 + i_monthly);
                            }
                        }
                        setResult('period', calculatedValue);
                        break;

                    default:
                        break;
                }
            } catch (error) {
                console.error("Error during calculation:", error);
                alert("เกิดข้อผิดพลาดในการคำนวณ กรุณาตรวจสอบข้อมูลและดูข้อความใน Console (F12)");
            }
        }

        // Initialize values from input fields on load if they exist (though inputs start empty)
        // This is primarily for when the user starts typing, to ensure tvmValues are updated.
        document.addEventListener('DOMContentLoaded', () => {
            const ids = ['pv', 'payment', 'fv', 'interest', 'period'];
            ids.forEach(id => {
                const inputElement = document.getElementById(id);
                // Attach oninput event listener if not already done in HTML
                if (!inputElement.hasAttribute('oninput')) {
                    inputElement.addEventListener('input', () => clearCalculatedState(id));
                }
                // Initial update from input if it's not empty on load
                if (inputElement.value !== '') {
                    tvmValues[id] = parseFloat(inputElement.value) || 0;
                }
            });
        });

        function clearAll() {
            const ids = ['pv', 'payment', 'fv', 'interest', 'period'];
            ids.forEach(id => {
                const inputElement = document.getElementById(id);
                inputElement.value = '';
                inputElement.removeAttribute('data-calculated');
                tvmValues[id] = 0; // Reset raw stored values
            });
        }
    </script>
</body>
</html>
